# Zyprus API Reference

Complete technical reference for the Zyprus Property/Land listing API integration.

## Overview

- **Backend**: Drupal 10 with JSON:API module
- **Base URL**: `https://zyprus.com`
- **Auth**: OAuth 2.0 Client Credentials
- **Format**: JSON:API specification (https://jsonapi.org/)

## Quick Start

```typescript
import {
  uploadPropertyToZyprusAPI,
  uploadLandToZyprusAPI,
  checkForDuplicates,
  getListingFromZyprus,
  searchZyprusListings
} from "@/lib/zyprus/client";

import {
  findLocationByName,
  findPropertyTypeByName,
  getAllLocations,
  forceRefreshCache
} from "@/lib/zyprus/taxonomy-cache";
```

---

## Authentication

### OAuth 2.0 Token Request

```http
POST /oauth/token HTTP/1.1
Host: zyprus.com
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials&client_id={ZYPRUS_CLIENT_ID}&client_secret={ZYPRUS_CLIENT_SECRET}
```

**Response**:
```json
{
  "access_token": "eyJ0eXAiOiJKV1...",
  "token_type": "Bearer",
  "expires_in": 3600
}
```

### Required Headers (ALL Requests)

```typescript
const headers = {
  "Authorization": `Bearer ${accessToken}`,
  "Content-Type": "application/vnd.api+json",
  "Accept": "application/vnd.api+json",
  "User-Agent": "SophiaAI/1.0"  // MANDATORY - API rejects without this
};
```

---

## Endpoints

### Properties

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/jsonapi/node/property` | List properties |
| GET | `/jsonapi/node/property/{uuid}` | Get single property |
| POST | `/jsonapi/node/property` | Create property |
| PATCH | `/jsonapi/node/property/{uuid}` | Update property |
| DELETE | `/jsonapi/node/property/{uuid}` | Delete property |
| POST | `/jsonapi/node/property/{uuid}/field_property_gallery` | Upload images |

### Land

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/jsonapi/node/land` | List land listings |
| GET | `/jsonapi/node/land/{uuid}` | Get single land |
| POST | `/jsonapi/node/land` | Create land listing |
| PATCH | `/jsonapi/node/land/{uuid}` | Update land |
| POST | `/jsonapi/node/land/{uuid}/field_land_gallery` | Upload images |

### Locations

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/jsonapi/node/location` | List all Cyprus locations |
| GET | `/jsonapi/node/location/{uuid}` | Get location details |

### Taxonomy Terms

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/jsonapi/taxonomy_term/{vocabulary}` | List terms in vocabulary |

**Vocabulary IDs**:
- `property_type` - Villa, Apartment, House, etc.
- `land_type` - Plot, Agricultural, Residential, etc.
- `indoor_property_features` - A/C, Fireplace, Storage, etc.
- `outdoor_property_features` - Pool, Garden, Parking, etc.
- `infrastructure_` - Electricity, Water, Road Access
- `property_views` - Sea View, Mountain View, City View
- `property_status` - Resale, New Build, Under Construction
- `listing_type` - For Sale, For Rent, Exchange
- `price_modifier` - Per sqm, Negotiable, etc.
- `title_deed` - Full, Pending, etc.

---

## Property Payload

### Create Property (POST /jsonapi/node/property)

```json
{
  "data": {
    "type": "node--property",
    "attributes": {
      "title": "Luxury Sea View Villa in Limassol",
      "status": false,
      "field_ai_state": "draft",
      "field_ai_generated": true,
      "field_ai_message": {
        "value": "Generated by SOFIA AI from chat abc123"
      },
      "field_ai_probably_exists": false,

      "field_price": 850000,
      "field_price_label": "€850,000",

      "field_bedrooms": 4,
      "field_bathrooms": 3,
      "field_covered_area": 250,
      "field_plot_area": 800,
      "field_year_built": 2022,
      "field_reference_id": "ZYP-2024-001",

      "field_map": {
        "value": "POINT (33.0413 34.6841)",
        "geo_type": "Point",
        "lat": 34.6841,
        "lon": 33.0413,
        "latlon": "34.6841,33.0413"
      },

      "field_energy_class": "A",
      "field_video_url": "https://youtube.com/watch?v=xxx",
      "field_phone_number": "+357 99 123456",

      "field_description": {
        "value": "<p>Beautiful villa with panoramic sea views...</p>",
        "format": "basic_html"
      },

      "field_property_notes": {
        "value": "Internal notes for admin",
        "format": "basic_html"
      }
    },
    "relationships": {
      "field_property_location": {
        "data": {
          "type": "node--location",
          "id": "location-uuid-here"
        }
      },
      "field_property_type": {
        "data": {
          "type": "taxonomy_term--property_type",
          "id": "property-type-uuid"
        }
      },
      "field_listing_type": {
        "data": {
          "type": "taxonomy_term--listing_type",
          "id": "listing-type-uuid"
        }
      },
      "field_property_status": {
        "data": {
          "type": "taxonomy_term--property_status",
          "id": "status-uuid"
        }
      },
      "field_property_views": {
        "data": [
          { "type": "taxonomy_term--property_views", "id": "sea-view-uuid" },
          { "type": "taxonomy_term--property_views", "id": "mountain-view-uuid" }
        ]
      },
      "field_indoor_features": {
        "data": [
          { "type": "taxonomy_term--indoor_property_features", "id": "ac-uuid" },
          { "type": "taxonomy_term--indoor_property_features", "id": "fireplace-uuid" }
        ]
      },
      "field_outdoor_features": {
        "data": [
          { "type": "taxonomy_term--outdoor_property_features", "id": "pool-uuid" },
          { "type": "taxonomy_term--outdoor_property_features", "id": "garden-uuid" }
        ]
      },
      "field_price_modifier": {
        "data": {
          "type": "taxonomy_term--price_modifier",
          "id": "modifier-uuid"
        }
      },
      "field_title_deed": {
        "data": {
          "type": "taxonomy_term--title_deed",
          "id": "deed-uuid"
        }
      }
    }
  }
}
```

### Field Descriptions

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `title` | string | Yes | Property title |
| `status` | boolean | Yes | **Always `false`** - unpublished draft |
| `field_ai_state` | string | Yes | **Always `"draft"`** for AI uploads |
| `field_ai_generated` | boolean | Yes | **Always `true`** for AI uploads |
| `field_price` | integer | Yes | Price in EUR (no decimals) |
| `field_bedrooms` | integer | No | Number of bedrooms |
| `field_bathrooms` | integer | No | Number of bathrooms |
| `field_covered_area` | integer | No | Built area in sqm |
| `field_plot_area` | integer | No | Plot/land area in sqm |
| `field_year_built` | integer | No | Construction year |
| `field_reference_id` | string | No | Unique reference code |
| `field_map` | object | No | Geo coordinates (see below) |
| `field_energy_class` | string | No | Energy rating (A-G) |

### Coordinate Format (field_map)

**CRITICAL**: Longitude comes BEFORE latitude in POINT format!

```json
{
  "value": "POINT (33.0413 34.6841)",  // LON LAT order
  "geo_type": "Point",
  "lat": 34.6841,
  "lon": 33.0413,
  "latlon": "34.6841,33.0413"  // LAT,LON for search
}
```

---

## Land Payload

### Create Land (POST /jsonapi/node/land)

Land uses **different field names** prefixed with `field_land_`:

```json
{
  "data": {
    "type": "node--land",
    "attributes": {
      "title": "Building Plot in Paphos",
      "status": false,
      "field_ai_state": "draft",
      "field_ai_generated": true,

      "field_land_price": 150000,
      "field_land_price_label": "€150,000",
      "field_land_size": 2000,

      "field_building_density": 0.8,
      "field_site_coverage": 0.5,
      "field_maximum_floors": 2,
      "field_maximum_height": 8.3,

      "field_land_reference_id": "LAND-2024-001",

      "field_land_map": {
        "value": "POINT (32.4218 34.7754)",
        "geo_type": "Point",
        "lat": 34.7754,
        "lon": 32.4218,
        "latlon": "34.7754,32.4218"
      },

      "field_land_description": {
        "value": "<p>Excellent plot for residential development...</p>",
        "format": "basic_html"
      }
    },
    "relationships": {
      "field_land_location": {
        "data": {
          "type": "node--location",
          "id": "location-uuid"
        }
      },
      "field_land_type": {
        "data": {
          "type": "taxonomy_term--land_type",
          "id": "land-type-uuid"
        }
      },
      "field_infrastructure": {
        "data": [
          { "type": "taxonomy_term--infrastructure_", "id": "electricity-uuid" },
          { "type": "taxonomy_term--infrastructure_", "id": "water-uuid" }
        ]
      },
      "field_land_views": {
        "data": [
          { "type": "taxonomy_term--property_views", "id": "sea-view-uuid" }
        ]
      },
      "field_land_price_modifier": {
        "data": {
          "type": "taxonomy_term--price_modifier",
          "id": "modifier-uuid"
        }
      },
      "field_land_title_deed": {
        "data": {
          "type": "taxonomy_term--title_deed",
          "id": "deed-uuid"
        }
      }
    }
  }
}
```

### Land-Specific Fields

| Field | Type | Description |
|-------|------|-------------|
| `field_land_size` | integer | Land area in sqm |
| `field_building_density` | float | Building density ratio (0-1) |
| `field_site_coverage` | float | Site coverage ratio (0-1) |
| `field_maximum_floors` | integer | Max allowed floors |
| `field_maximum_height` | float | Max building height in meters |

### Field Name Mapping (Property vs Land)

| Property Field | Land Field |
|----------------|------------|
| `field_price` | `field_land_price` |
| `field_property_location` | `field_land_location` |
| `field_property_gallery` | `field_land_gallery` |
| `field_map` | `field_land_map` |
| `field_reference_id` | `field_land_reference_id` |
| `field_property_views` | `field_land_views` |
| `field_price_modifier` | `field_land_price_modifier` |
| `field_title_deed` | `field_land_title_deed` |

---

## File Upload

### Upload Images to Property

```http
POST /jsonapi/node/property/{uuid}/field_property_gallery HTTP/1.1
Host: zyprus.com
Authorization: Bearer {token}
Content-Type: application/octet-stream
Content-Disposition: file; filename="property-image-1.jpg"
Accept: application/vnd.api+json
User-Agent: SophiaAI/1.0

{binary image data}
```

### Upload Floor Plan Images

```http
POST /jsonapi/node/property/{uuid}/field_floor_plan HTTP/1.1
...
```

### Upload PDF Documents

```http
POST /jsonapi/node/property/{uuid}/field_floor_plan_pdf HTTP/1.1
...
```

### Upload EPC Certificate

```http
POST /jsonapi/node/property/{uuid}/field_epc_pdf HTTP/1.1
...
```

### File Field Types

| Node Type | Field | Accepts |
|-----------|-------|---------|
| Property | `field_property_gallery` | JPG, PNG, WebP |
| Property | `field_floor_plan` | JPG, PNG, WebP |
| Property | `field_floor_plan_pdf` | PDF |
| Property | `field_epc_pdf` | PDF |
| Land | `field_land_gallery` | JPG, PNG, WebP |

---

## Querying & Filtering

### Filter by AI State

```http
GET /jsonapi/node/property?filter[field_ai_state]=draft
```

### Filter by AI Generated

```http
GET /jsonapi/node/property?filter[field_ai_generated]=1
```

### Filter by Location

```http
GET /jsonapi/node/property?filter[field_property_location.id]={location-uuid}
```

### Filter by Price Range

```http
GET /jsonapi/node/property?filter[price-min][condition][path]=field_price&filter[price-min][condition][operator]=%3E%3D&filter[price-min][condition][value]=100000&filter[price-max][condition][path]=field_price&filter[price-max][condition][operator]=%3C%3D&filter[price-max][condition][value]=500000
```

### Include Related Data

```http
GET /jsonapi/node/property/{uuid}?include=field_property_location,field_property_type,field_property_gallery
```

### Pagination

```http
GET /jsonapi/node/property?page[limit]=50&page[offset]=0
```

---

## TypeScript Functions

### Upload Property

```typescript
const result = await uploadPropertyToZyprusAPI({
  title: "Sea View Villa",
  price: 450000,
  bedrooms: 3,
  bathrooms: 2,
  coveredArea: 150,
  plotArea: 500,
  locationId: "location-uuid",
  propertyTypeId: "villa-uuid",
  listingTypeId: "for-sale-uuid",
  propertyStatusId: "new-build-uuid",
  viewIds: ["sea-view-uuid"],
  indoorFeatureIds: ["ac-uuid", "fireplace-uuid"],
  outdoorFeatureIds: ["pool-uuid"],
  chatId: "chat-session-id",  // For AI tracking
  duplicateDetected: false
});

// result.id = UUID of created property
```

### Upload Land

```typescript
const result = await uploadLandToZyprusAPI({
  title: "Building Plot",
  price: 150000,
  landSize: 2000,
  buildingDensity: 0.8,
  siteCoverage: 0.5,
  maxFloors: 2,
  maxHeight: 8.3,
  locationId: "location-uuid",
  landTypeId: "residential-uuid",
  infrastructureIds: ["electricity-uuid", "water-uuid"],
  viewIds: ["sea-view-uuid"]
});
```

### Check Duplicates

```typescript
const result = await checkForDuplicates({
  referenceId: "ZYP-123",
  locationId: "location-uuid",
  price: 450000,
  title: "Sea View Villa"
});

if (result.hasDuplicate) {
  console.log(`Duplicate found: ${result.existingListingTitle}`);
  console.log(`Confidence: ${result.confidence}`);
  console.log(`Match type: ${result.matchType}`);
}
```

### Get Listing

```typescript
const listing = await getListingFromZyprus("property-uuid");
// Returns full property data with relationships
```

### Search Listings

```typescript
const results = await searchZyprusListings({
  aiState: "draft",
  aiGenerated: true,
  locationId: "limassol-uuid",
  minPrice: 100000,
  maxPrice: 500000
});
```

### Taxonomy Functions

```typescript
// Refresh cache
await forceRefreshCache();

// Find IDs by name
const locationId = await findLocationByName("Limassol");
const typeId = await findPropertyTypeByName("Villa");
const landTypeId = await findLandTypeByName("Residential");
const statusId = await findPropertyStatusByName("New Build");
const listingTypeId = await findListingTypeByName("For Sale");

// Find multiple IDs
const indoorIds = await findIndoorFeatureIds(["Air Conditioning", "Fireplace"]);
const outdoorIds = await findOutdoorFeatureIds(["Pool", "Garden"]);
const infraIds = await findInfrastructureIds(["Electricity", "Water"]);
const viewIds = await findPropertyViewIds(["Sea View", "Mountain View"]);

// Get all options
const locations = await getAllLocations();      // [{name, id}]
const types = await getAllPropertyTypes();
const landTypes = await getAllLandTypes();
const views = await getAllPropertyViews();
const statuses = await getAllPropertyStatus();
const listingTypes = await getAllListingTypes();
```

---

## Error Handling

### HTTP Status Codes

| Code | Meaning | Action |
|------|---------|--------|
| 200 | Success | Process response |
| 201 | Created | Extract UUID from response |
| 400 | Bad Request | Check payload structure |
| 401 | Unauthorized | Re-authenticate |
| 403 | Forbidden | Check User-Agent header |
| 404 | Not Found | Verify UUID exists |
| 422 | Unprocessable | Check relationship UUIDs |
| 429 | Rate Limited | Wait and retry |
| 500 | Server Error | Log and retry later |

### Error Response Format

```json
{
  "errors": [
    {
      "status": "422",
      "title": "Unprocessable Entity",
      "detail": "field_property_location: This value should not be null.",
      "source": {
        "pointer": "/data/relationships/field_property_location"
      }
    }
  ]
}
```

### Circuit Breaker

The client uses Opossum circuit breaker:
- Opens after 50% failures
- Timeout: 30 seconds
- Reset timeout: 30 seconds

```typescript
// Separate breakers for each operation
const propertyUploadBreaker = new CircuitBreaker(...);
const landUploadBreaker = new CircuitBreaker(...);
const fileUploadBreaker = new CircuitBreaker(...);
```

---

## AI Integration Fields

### Required for AI Uploads

| Field | Value | Purpose |
|-------|-------|---------|
| `status` | `false` | Unpublished draft |
| `field_ai_state` | `"draft"` | Mark as AI-generated draft |
| `field_ai_generated` | `true` | Track AI-generated content |

### Optional AI Fields

| Field | Type | Purpose |
|-------|------|---------|
| `field_ai_message` | text | Chat context info |
| `field_ai_probably_exists` | boolean | Duplicate detection flag |

### AI State Values

- `draft` - Initial AI-generated state
- `pending_review` - Awaiting human review
- `approved` - Human approved
- `rejected` - Human rejected

---

## Environment Variables

```bash
# Required
ZYPRUS_CLIENT_ID=your-oauth-client-id
ZYPRUS_CLIENT_SECRET=your-oauth-client-secret

# Optional
ZYPRUS_API_URL=https://zyprus.com  # Defaults to this
```

---

## Postman MCP Tools

When using Postman MCP to explore the API:

```typescript
// 1. Get authenticated user info
await mcp__postman__getAuthenticatedUser();

// 2. List workspaces
await mcp__postman__getWorkspaces();

// 3. List collections in workspace
await mcp__postman__getCollections({ workspace: "workspace-id" });

// 4. Get collection with all requests
await mcp__postman__getCollection({ collectionId: "owner-id-collection-id" });

// 5. Get environments for variables
await mcp__postman__getEnvironments({ workspace: "workspace-id" });
```

### Collection Structure

```typescript
interface Collection {
  info: { name: string; schema: string };
  item: Array<{
    name: string;
    item?: Array<...>;  // Nested folders
    request?: {
      method: string;
      url: { raw: string; host: string[]; path: string[] };
      header: Array<{ key: string; value: string }>;
      body?: { mode: string; raw: string };
      auth?: { type: string; bearer?: Array<{ key: string; value: string }> };
    };
  }>;
  variable?: Array<{ key: string; value: string }>;
}
```

---

## Common Gotchas

1. **User-Agent Required**: API returns 403 without `User-Agent: SophiaAI/1.0`

2. **LON before LAT**: POINT format is `POINT (longitude latitude)`

3. **status: false**: Always upload as unpublished draft

4. **Land field prefixes**: Land uses `field_land_*` not `field_*`

5. **Taxonomy term types**: Include full type like `taxonomy_term--property_type`

6. **UUID format**: Use full UUID, not numeric ID

7. **Multi-value relationships**: Always use array format `data: [...]`

8. **Text fields**: Use `{ value: "...", format: "basic_html" }` for HTML
