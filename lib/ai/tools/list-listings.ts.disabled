import { tool } from "ai";
import { z } from "zod";
import { getListingsByUserId } from "@/lib/db/queries";

const STATUS_EMOJIS: Record<string, string> = {
  draft: "ğŸ“",
  queued: "â³",
  uploading: "â¬†ï¸",
  uploaded: "âœ…",
  failed: "âŒ",
  published: "âœ…",
};

export const listListingsTool = tool({
  description:
    "Show user's property listings with status. Displays recent listings created by the user.",
  parameters: z.object({
    limit: z
      .number()
      .int()
      .min(1)
      .max(50)
      .default(10)
      .describe("Number of listings to show (max 50)"),
  }),
  execute: async (args: any, options: any) => {
    const { limit } = args;
    const userId = options?.session?.user?.id;

    if (!userId) {
      return { success: false, error: "Authentication required" };
    }

    try {
      const listings = await getListingsByUserId({ userId, limit });

      if (listings.length === 0) {
        return {
          success: true,
          message:
            "You haven't created any listings yet. Start by saying 'create a listing'",
        };
      }

      const formatted = listings
        .map((listing: any, index: number) => {
          const emoji = STATUS_EMOJIS[listing.status] || "â“";
          const price = parseFloat(listing.price);
          const createdDate = new Date(listing.createdAt).toLocaleDateString();

          let statusLine = `Status: ${listing.status}`;
          if (listing.zyprusListingId) {
            statusLine += ` | ID: #${listing.zyprusListingId}`;
          }

          return `${index + 1}. ${emoji} **${listing.name}**
   ğŸ“ ${listing.address.addressLocality} | ğŸ’° â‚¬${price.toLocaleString()}
   ğŸ›ï¸ ${listing.numberOfRooms} bed | ğŸš¿ ${listing.numberOfBathroomsTotal} bath | ğŸ“ ${listing.floorSize}mÂ²
   ${statusLine}
   Created: ${createdDate}`;
        })
        .join("\n\n");

      return {
        success: true,
        message: `ğŸ“‹ **Your Property Listings** (${listings.length} total)\n\n${formatted}`,
      };
    } catch (error) {
      console.error("Error listing properties:", error);
      return {
        success: false,
        error: "Failed to retrieve listings",
      };
    }
  },
});
